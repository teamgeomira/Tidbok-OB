<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tidbok OB - Timregistrering</title>
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Firebase SDK Modular -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, updateProfile } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getDatabase, ref, set, push, onValue, update, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
        
        // Firebase-konfiguration
        const firebaseConfig = {
            apiKey: "AIzaSyDLezJUZMmeLllsdEPCUVkDBKwwR6OuoD8",
            authDomain: "userbase-5061c.firebaseapp.com",
            databaseURL: "https://userbase-5061c-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "userbase-5061c",
            storageBucket: "userbase-5061c.firebasestorage.app",
            messagingSenderId: "414829360217",
            appId: "1:414829360217:web:21d0839ee0ccfbea336d48"
        };
        
        // Initiera Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const database = getDatabase(app);
        
        // Exportera till global scope för användning i andra script-delar
        window.firebase = {
            auth,
            database,
            ref,
            set,
            push,
            onValue,
            update,
            remove,
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            signOut,
            onAuthStateChanged,
            updateProfile
        };
    </script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- jsPDF y AutoTable -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* Estilos personalizados */
        .ob-base { background-color: #dbeafe; }
        .ob-1 { background-color: #ffedd5; }
        .ob-2 { background-color: #fee2e2; }
        .ob-3 { background-color: #ede9fe; }
        .ob-4 { background-color: #dcfce7; }
        
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        
        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        
        .connection-online { background-color: #10b981; }
        .connection-offline { background-color: #ef4444; }
        
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .settings-panel {
            transition: all 0.3s ease;
            overflow: hidden;
        }
        
        .settings-panel.hidden {
            max-height: 0;
            opacity: 0;
            padding: 0;
        }
        
        .form-group {
            margin-bottom: 1rem;
        }
        
        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #374151;
        }
        
        .form-control {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            font-size: 16px; /* Prevenir zoom en iOS */
        }
        
        .btn-primary {
            background-color: #3b82f6;
            color: white;
            padding: 0.75rem 1rem;
            border-radius: 0.375rem;
            font-weight: 500;
            cursor: pointer;
            font-size: 16px; /* Prevenir zoom en iOS */
        }
        
        .btn-primary:hover {
            background-color: #2563eb;
        }
        
        .tab-button {
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            background-color: #f9fafb;
            cursor: pointer;
            font-size: 16px; /* Prevenir zoom en iOS */
        }
        
        .tab-button.active {
            background-color: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }
        
        .auth-tab {
            display: none;
        }
        
        .auth-tab.active {
            display: block;
        }
        
        .month-header {
            cursor: pointer;
            padding: 0.75rem;
            background-color: #f1f5f9;
            border-radius: 0.375rem;
            margin-bottom: 0.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .month-header:hover {
            background-color: #e2e8f0;
        }
        
		.month-content {
			overflow: hidden;
			transition: max-height 0.3s ease;
			max-height: 0;
		}

		.month-content.collapsed {
			max-height: 0;
		}

		.month-content.expanded {
			max-height: 5000px; /* Valor suficientemente grande */
			overflow-y: auto; /* Permite scroll si es necesario */
		}
        
        .chevron {
            transition: transform 0.3s ease;
        }
        
        .chevron.rotated {
            transform: rotate(180deg);
        }
        
        /* Estilos específicos para móviles */
        .mobile-menu {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
            padding: 0.5rem 0;
        }
        
        .mobile-menu.active {
            display: flex;
        }
        
        .mobile-menu-item {
            flex: 1;
            text-align: center;
            padding: 0.5rem;
            color: #6b7280;
            font-size: 0.75rem;
        }
        
        .mobile-menu-item.active {
            color: #3b82f6;
        }
        
        .mobile-menu-item i {
            display: block;
            font-size: 1.25rem;
            margin-bottom: 0.25rem;
        }
        
        .section {
            display: none;
            padding-bottom: 80px; /* Espacio para el menú móvil */
        }
        
        .section.active {
            display: block;
        }
        
        /* Mejoras para pantallas pequeñas */
        @media (max-width: 768px) {
            .container {
                padding-left: 0.5rem;
                padding-right: 0.5rem;
            }
            
            .desktop-only {
                display: none;
            }
            
            .mobile-only {
                display: block;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 0.5rem;
            }
            
            .ob-card {
                padding: 0.5rem;
            }
            
            .ob-card .text-2xl {
                font-size: 1.1rem;
            }
            
            .filter-bar {
                flex-direction: column;
                gap: 0.5rem;
            }
            
            .filter-bar select {
                width: 100%;
                font-size: 14px;
            }
            
            .mobile-menu-item {
                padding: 0.25rem;
            }
            
            .mobile-menu-item i {
                font-size: 1rem;
            }
            
            .mobile-menu-item span {
                font-size: 0.7rem;
            }
            
            .section {
                padding-bottom: 70px;
            }
        }
        
        @media (min-width: 769px) {
            .mobile-only {
                display: none;
            }
        }
        
        /* Mejoras para formularios en móviles */
        input[type="date"], input[type="time"], select {
            font-size: 16px; /* Prevenir zoom en iOS */
        }
        
        /* Mejoras para la tabla de historial en móviles */
        .table-responsive {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .table-responsive table {
            min-width: 600px;
        }
        
        /* Estilos para modales en móviles */
        .modal-content {
            max-height: 80vh;
            overflow-y: auto;
        }
        
        /* Mejoras para el menú de navegación en móviles */
        nav .container {
            padding: 0.5rem 1rem;
        }
        
        nav h1 {
            font-size: 1.1rem;
        }
        
        #user-info {
            font-size: 0.9rem;
        }
        
        /* Mejoras para botones en móviles */
        button {
            touch-action: manipulation;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div id="app" class="flex flex-col min-h-screen">
        <!-- Navigationsfält -->
        <nav class="bg-blue-600 text-white shadow-lg">
            <div class="container mx-auto px-4 py-3 flex justify-between items-center">
                <div class="flex items-center">
                    <i class="fas fa-clock text-2xl mr-2"></i>
                    <h1 class="text-xl font-bold">Tidbok OB</h1>
                </div>
                
                <div class="flex items-center space-x-4">
                    <a href="https://teamgeomira.github.io/Korjournal/" target="_blank" 
                       class="flex items-center bg-white text-blue-600 px-3 py-1 rounded hover:bg-gray-200 transition text-sm">
                        <i class="fas fa-car mr-1"></i>
                        <span>Korjournal</span>
                    </a>
                    
                    <div id="connection-status" class="flex items-center px-3 py-1 rounded-full text-white connection-online">
                        <span class="w-3 h-3 rounded-full bg-white mr-1"></span>
                        <span class="text-sm">Online</span>
                    </div>
                    
                    <button id="settings-toggle" class="p-2 rounded-full hover:bg-blue-700">
                        <i class="fas fa-cog"></i>
                    </button>
                    
                    <div id="user-info" class="hidden">
                        <div class="flex items-center">
                            <img id="user-avatar" class="w-8 h-8 rounded-full mr-2" src="https://ui-avatars.com/api/?background=random&name=U" alt="Avatar">
                            <span id="user-name" class="mr-2 text-sm">Användare</span>
                            <button id="profile-btn" class="bg-white text-blue-600 px-2 py-1 rounded hover:bg-gray-200 transition mr-2">
                                <i class="fas fa-user"></i>
                            </button>
                            <button id="logout-btn" class="bg-white text-blue-600 px-2 py-1 rounded hover:bg-gray-200 transition">
                                <i class="fas fa-sign-out-alt"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Settings Panel -->
        <div id="settings-panel" class="settings-panel bg-gray-100 border-b hidden">
            <div class="container mx-auto px-4 py-4">
                <h3 class="text-lg font-semibold mb-4">Företagsinställningar</h3>
                <form id="company-settings-form" class="grid grid-cols-1 gap-4">
                    <div class="form-group">
                        <label for="company-name" class="form-label">Företagsnamn (valfritt)</label>
                        <input type="text" id="company-name" class="form-control" placeholder="Team Geomira AB">
                    </div>		
                    <div class="form-group">
                        <label for="company-address" class="form-label">Adress</label>
                        <input type="text" id="company-address" class="form-control" placeholder="Köpmangatan 5, plan 10">
                    </div>
                    <div class="form-group">
                        <label for="company-postal" class="form-label">Postnummer och ort</label>
                        <input type="text" id="company-postal" class="form-control" placeholder="151 71 Södertälje">
                    </div>
                    <div class="form-group">
                        <label for="company-phone" class="form-label">Telefon</label>
                        <input type="text" id="company-phone" class="form-control" placeholder="079-079 00 45">
                    </div>
                    <div class="form-group">
                        <label for="company-orgnr" class="form-label">Organisationsnummer</label>
                        <input type="text" id="company-orgnr" class="form-control" placeholder="559096-5983">
                    </div>
                    <div class="form-group">
                        <button type="submit" class="btn-primary w-full">Spara inställningar</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Huvudinnehåll -->
        <main class="flex-grow container mx-auto px-4 py-6">
            <!-- Inloggningsskärm -->
            <div id="auth-screen" class="max-w-md mx-auto bg-white rounded-xl shadow-md p-6 fade-in">
                <div class="text-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">Tidbok OB</h2>
                    <p class="text-gray-600">Logga in för att hantera dina timmar</p>
                </div>
                
                <div class="flex border-b mb-4">
                    <button id="login-tab-btn" class="tab-button active w-1/2">Logga in</button>
                    <button id="register-tab-btn" class="tab-button w-1/2">Skapa konto</button>
                </div>
                
                <!-- Inloggning -->
                <div id="login-tab" class="auth-tab active">
                    <div class="mb-4">
                        <label class="block text-gray-700 mb-2" for="email">E-post</label>
                        <input type="email" id="email" class="w-full px-3 py-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" autocomplete="email">
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-gray-700 mb-2" for="password">Lösenord</label>
                        <input type="password" id="password" class="w-full px-3 py-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" autocomplete="current-password">
                    </div>
                    
                    <div class="mb-6">
                        <button id="login-btn" class="w-full bg-blue-600 text-white py-3 px-4 rounded-md hover:bg-blue-700 transition">
                            Logga in
                        </button>
                    </div>
                </div>
                
                <!-- Registrering -->
                <div id="register-tab" class="auth-tab">
                    <div class="mb-4">
                        <label class="block text-gray-700 mb-2" for="reg-email">E-post</label>
                        <input type="email" id="reg-email" class="w-full px-3 py-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" autocomplete="email">
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-gray-700 mb-2" for="reg-password">Lösenord</label>
                        <input type="password" id="reg-password" class="w-full px-3 py-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" autocomplete="new-password">
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-gray-700 mb-2" for="reg-firstname">Förnamn</label>
                        <input type="text" id="reg-firstname" class="w-full px-3 py-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" autocomplete="given-name">
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-gray-700 mb-2" for="reg-lastname">Efternamn</label>
                        <input type="text" id="reg-lastname" class="w-full px-3 py-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" autocomplete="family-name">
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-gray-700 mb-2" for="reg-phone">Telefon</label>
                        <input type="tel" id="reg-phone" class="w-full px-3 py-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" autocomplete="tel">
                    </div>
                    
                    <div class="mb-6">
                        <label class="block text-gray-700 mb-2" for="reg-personalnumber">Personnummer</label>
                        <input type="text" id="reg-personalnumber" class="w-full px-3 py-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" autocomplete="off">
                    </div>
                    
                    <div class="mb-6">
                        <button id="register-btn" class="w-full bg-green-500 text-white py-3 px-4 rounded-md hover:bg-green-600 transition">
                            Skapa konto
                        </button>
                    </div>
                </div>
                
                <div id="auth-message" class="text-center text-red-500"></div>
            </div>

            <!-- Appens huvudinnehåll (dold initialt) -->
            <div id="app-content" class="hidden fade-in">
                <!-- Menú móvil -->
                <div id="mobile-menu" class="mobile-menu">
                    <div class="mobile-menu-item active" data-section="register">
                        <i class="fas fa-clock"></i>
                        <span>Registrera</span>
                    </div>
                    <div class="mobile-menu-item" data-section="projects">
                        <i class="fas fa-folder"></i>
                        <span>Projekt</span>
                    </div>
                    <div class="mobile-menu-item" data-section="history">
                        <i class="fas fa-history"></i>
                        <span>Historik</span>
                    </div>
                    <div class="mobile-menu-item" data-section="stats">
                        <i class="fas fa-chart-bar"></i>
                        <span>Statistik</span>
                    </div>
                </div>
                
				<!-- Sección: Registrera timmar -->
				<div id="register-section" class="section active">
					<div class="bg-white rounded-xl shadow-md p-6 mb-6">
						<h2 class="text-xl font-bold text-gray-800 mb-4">Registrera timmar</h2>

						<div class="space-y-4">

							<div>
								<label class="block text-gray-700 mb-2">Datum</label>
								<input type="date" id="work-date"
									class="w-full px-3 py-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
							</div>

							<div>
								<label class="block text-gray-700 mb-2">Projekt</label>

								<select id="project-select"
									class="w-full px-3 py-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
									<option value="">Välj projekt</option>
								</select>

								<button id="new-project-btn" class="mt-2 text-sm text-blue-600 hover:underline">
									<i class="fas fa-plus mr-1"></i> Nytt projekt
								</button>
							</div>
								<script>
									// Sobrescribe el comportamiento al cargar proyectos
									function loadProjects(userId) {
										const projectsRef = window.firebase.ref(window.firebase.database, `users/${userId}/projects`);

										window.firebase.onValue(projectsRef, (snapshot) => {
											const projectSelect = document.getElementById("project-select");

											// Vaciar opciones excepto "Välj projekt"
											while (projectSelect.options.length > 1) {
												projectSelect.remove(1);
											}

											const loadedProjects = [];

											snapshot.forEach((child) => {
												const project = { id: child.key, ...child.val() };
												loadedProjects.push(project);

												const opt = document.createElement("option");
												opt.value = project.id;
												opt.textContent = project.name;
												projectSelect.appendChild(opt);
											});

											// Auto-seleccionar el primer proyecto si existe
											if (loadedProjects.length > 0) {
												projectSelect.value = loadedProjects[0].id;
											}
										});
									}
								</script>
							</div>

                            
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-gray-700 mb-2">Starttid</label>
                                    <input type="time" id="start-time" value="01:30" class="w-full px-3 py-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label class="block text-gray-700 mb-2">Sluttid</label>
                                    <input type="time" id="end-time" value="10:00" class="w-full px-3 py-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-gray-700 mb-2">Rast</label>
                                <select id="break-time" class="w-full px-3 py-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <option value="0.0">0.0</option>
                                    <option value="0.5" selected>En halvtimme</option>
                                    <option value="1">1 timme</option>
                                    <option value="2">2 timmar</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-gray-700 mb-2">Kollegor</label>
                                <input type="text" id="colleagues" placeholder="Namn separerade med kommatecken" class="w-full px-3 py-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            
                            <div>
                                <label class="block text-gray-700 mb-2">Anteckningar</label>
                                <textarea id="notes" rows="2" class="w-full px-3 py-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                            </div>
                            
                            <button id="save-hours-btn" class="w-full bg-blue-600 text-white py-3 px-4 rounded-md hover:bg-blue-700 transition">
                                Spara registrering
                            </button>
                        </div>
                    </div>
                    
                    <!-- OB-timmar sammanfattning -->
                    <div class="bg-white rounded-xl shadow-md p-6 mb-6">
                        <h2 class="text-xl font-bold text-gray-800 mb-4">OB-timmar sammanfattning</h2>
                        
                        <div class="grid grid-cols-3 gap-4 stats-grid">
                            <div class="ob-base p-4 rounded-lg text-center ob-card">
                                <div class="text-2xl font-bold" id="base-hours">0.00</div>
                                <div class="text-sm">Baslön</div>
                            </div>
                            <div class="ob-1 p-4 rounded-lg text-center ob-card">
                                <div class="text-2xl font-bold" id="ob1-hours">0.00</div>
                                <div class="text-sm">OB 1</div>
                            </div>
                            <div class="ob-2 p-4 rounded-lg text-center ob-card">
                                <div class="text-2xl font-bold" id="ob2-hours">0.00</div>
                                <div class="text-sm">OB 2</div>
                            </div>
                            <div class="ob-3 p-4 rounded-lg text-center ob-card">
                                <div class="text-2xl font-bold" id="ob3-hours">0.00</div>
                                <div class="text-sm">OB 3</div>
                            </div>
                            <div class="ob-4 p-4 rounded-lg text-center ob-card">
                                <div class="text-2xl font-bold" id="ob4-hours">0.00</div>
                                <div class="text-sm">OB 4</div>
                            </div>
                            <div class="ob-total p-4 rounded-lg text-center bg-gray-100 ob-card">
                                <div class="text-2xl font-bold" id="total-hours">0.00</div>
                                <div class="text-sm">Totalt</div>
                            </div>								
                        </div>
                    </div>
                </div>
                
                <!-- Sección: Projekt -->
                <div id="projects-section" class="section">
                    <div class="bg-white rounded-xl shadow-md p-6 mb-6">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-xl font-bold text-gray-800">Mina projekt</h2>
                            <button id="create-project-btn" class="bg-blue-600 text-white p-3 rounded-full hover:bg-blue-700 transition">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                        
                        <div id="projects-list" class="space-y-2 max-h-96 overflow-y-auto scrollbar-hide">
                            <!-- Projekt kommer att laddas här -->
                        </div>
                    </div>
                </div>
                
                <!-- Sección: Historik -->
                <div id="history-section" class="section">
                    <div class="bg-white rounded-xl shadow-md p-6 mb-6">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-xl font-bold text-gray-800">Tidshistorik</h2>
                            <div class="flex space-x-2 filter-bar">
                                <select id="filter-year" class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <option value="all">Alla år</option>
                                </select>
                                <select id="filter-month" class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <option value="all">Alla månader</option>
                                </select>
                                <select id="filter-ob" class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <option value="all">Alla OB-typer</option>
                                    <option value="base">Baslön</option>
                                    <option value="ob1">OB 1</option>
                                    <option value="ob2">OB 2</option>
                                    <option value="ob3">OB 3</option>
                                    <option value="ob4">OB 4</option>
                                </select>
                                <button id="sort-order" class="bg-blue-600 text-white p-2 rounded-md hover:bg-blue-700 transition">
                                    <i class="fas fa-sort-amount-down"></i>
                                </button>
                                <div class="flex space-x-2">
                                    <button id="export-pdf" class="bg-red-600 text-white p-2 rounded-md hover:bg-red-700 transition">
                                        <i class="fas fa-file-pdf"></i>
                                    </button>
                                    <button id="export-word" class="bg-green-600 text-white p-2 rounded-md hover:bg-green-700 transition">
                                        <i class="fas fa-file-word"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div id="hours-history" class="overflow-x-auto table-responsive">
                            <!-- Historik kommer att laddas här med månadsgrupper -->
                        </div>
                    </div>
                </div>
                
                <!-- Sección: Statistik -->
                <div id="stats-section" class="section">
                    <div class="bg-white rounded-xl shadow-md p-6 mb-6">
                        <h2 class="text-xl font-bold text-gray-800 mb-4">Statistik</h2>
                        
                        <div class="space-y-6">
                            <div>
                                <h3 class="font-medium text-gray-700 mb-3">Fördelning per projekt</h3>
                                <canvas id="project-chart" height="250"></canvas>
                            </div>
                            <div>
                                <h3 class="font-medium text-gray-700 mb-3">Timmar per vecka</h3>
                                <canvas id="weekly-chart" height="250"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Sidfot -->
        <footer class="bg-gray-800 text-white py-4 mt-auto desktop-only">
            <div class="container mx-auto px-4 text-center">
                <p>Tidbok OB &copy; 2025 - Alla rättigheter förbehållna</p>
            </div>
        </footer>
    </div>

    <!-- Modaler -->
    <!-- Modal för nytt projekt -->
    <div id="project-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-xl shadow-lg w-full max-w-sm md:max-w-md p-4 md:p-6 mx-4 modal-content">
            <h3 class="text-xl font-bold text-gray-800 mb-4">Nytt Projekt</h3>
            
            <div class="mb-4">
                <label class="block text-gray-700 mb-2">Projektnamn</label>
                <input type="text" id="project-name" class="w-full px-3 py-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            
            <div class="mb-4">
                <label class="block text-gray-700 mb-2">Projektkod</label>
                <input type="text" id="project-code" class="w-full px-3 py-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            
            <div class="mb-4">
                <label class="block text-gray-700 mb-2">Beskrivning (valfritt)</label>
                <textarea id="project-description" rows="2" class="w-full px-3 py-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
            </div>
            
            <div class="flex justify-end space-x-3">
                <button id="cancel-project-btn" class="px-4 py-2 text-gray-600 hover:text-gray-800">Avbryt</button>
                <button id="save-project-btn" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition">Spara</button>
            </div>
        </div>
    </div>

    <!-- Modal för användarprofil -->
    <div id="profile-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-xl shadow-lg w-full max-w-sm md:max-w-md p-4 md:p-6 mx-4 modal-content">
            <h3 class="text-xl font-bold text-gray-800 mb-4">Min Profil</h3>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-gray-700 mb-2">Förnamn</label>
                    <input type="text" id="profile-firstname" class="w-full px-3 py-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                
                <div>
                    <label class="block text-gray-700 mb-2">Efternamn</label>
                    <input type="text" id="profile-lastname" class="w-full px-3 py-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                
                <div>
                    <label class="block text-gray-700 mb-2">E-post</label>
                    <input type="email" id="profile-email" class="w-full px-3 py-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" readonly>
                </div>
                
                <div>
                    <label class="block text-gray-700 mb-2">Telefon</label>
                    <input type="text" id="profile-phone" class="w-full px-3 py-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                
                <div>
                    <label class="block text-gray-700 mb-2">Personnummer</label>
                    <input type="text" id="profile-personalnumber" class="w-full px-3 py-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
            </div>
            
            <div class="mt-6 flex justify-end space-x-3">
                <button id="cancel-profile-btn" class="px-4 py-2 text-gray-600 hover:text-gray-800">Avbryt</button>
                <button id="save-profile-btn" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition">Spara</button>
            </div>
        </div>
    </div>

    <!-- Modal för registreringsdetaljer -->
    <div id="detail-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-xl shadow-lg w-full max-w-sm md:max-w-md p-4 md:p-6 mx-4 modal-content">
            <h3 class="text-xl font-bold text-gray-800 mb-4">Registreringsdetaljer</h3>
            
            <div id="detail-content" class="space-y-3">
                <!-- Dynamiskt innehåll -->
            </div>
            
            <div class="mt-6 flex justify-end">
                <button id="close-detail-btn" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition">Stäng</button>
            </div>
        </div>
    </div>

    <!-- Modal för redigering -->
    <div id="edit-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-xl shadow-lg w-full max-w-sm md:max-w-md p-4 md:p-6 mx-4 modal-content">
            <h3 class="text-xl font-bold text-gray-800 mb-4">Redigera Registrering</h3>
            
            <div id="edit-content" class="space-y-4">
                <input type="hidden" id="edit-id">
                <div>
                    <label class="block text-gray-700 mb-2">Datum</label>
                    <input type="date" id="edit-date" class="w-full px-3 py-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                
                <div>
                    <label class="block text-gray-700 mb-2">Projekt</label>
                    <select id="edit-project" class="w-full px-3 py-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">Välj projekt</option>
                    </select>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-gray-700 mb-2">Starttid</label>
                        <input type="time" id="edit-start" class="w-full px-3 py-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-gray-700 mb-2">Sluttid</label>
                        <input type="time" id="edit-end" class="w-full px-3 py-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>
                
                <div>
                    <label class="block text-gray-700 mb-2">Rast</label>
                    <select id="edit-break" class="w-full px-3 py-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="0.5">En halvtimme</option>
                        <option value="1">1 timme</option>
                        <option value="2">2 timmar</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-gray-700 mb-2">Kollegor</label>
                    <input type="text" id="edit-colleagues" placeholder="Namn separerade med kommatecken" class="w-full px-3 py-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                
                <div>
                    <label class="block text-gray-700 mb-2">Anteckningar</label>
                    <textarea id="edit-notes" rows="2" class="w-full px-3 py-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                </div>
            </div>
            
            <div class="mt-6 flex justify-end space-x-3">
                <button id="cancel-edit-btn" class="px-4 py-2 text-gray-600 hover:text-gray-800">Avbryt</button>
                <button id="save-edit-btn" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition">Spara</button>
            </div>
        </div>
    </div>

    <!-- Modal för PDF-exportfilter -->
    <div id="pdf-filter-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-xl shadow-lg w-full max-w-sm md:max-w-md p-4 md:p-6 mx-4 modal-content">
            <h3 class="text-xl font-bold text-gray-800 mb-4">Exportera till PDF/Word</h3>
            
            <div class="space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-gray-700 mb-2">Från datum</label>
                        <input type="date" id="pdf-start-date" class="w-full px-3 py-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-gray-700 mb-2">Till datum</label>
                        <input type="date" id="pdf-end-date" class="w-full px-3 py-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>
                
                <div>
                    <label class="block text-gray-700 mb-2">Projekt</label>
                    <select id="pdf-project" class="w-full px-3 py-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="all">Alla projekt</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-gray-700 mb-2">OB-typ</label>
                    <select id="pdf-ob" class="w-full px-3 py-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="all">Alla OB-typer</option>
                        <option value="base">Baslön</option>
                        <option value="ob1">OB 1</option>
                        <option value="ob2">OB 2</option>
                        <option value="ob3">OB 3</option>
                        <option value="ob4">OB 4</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-gray-700 mb-2">Sortera efter</label>
                    <select id="pdf-sort" class="w-full px-3 py-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="date">Datum</option>
                        <option value="project">Projekt</option>
                        <option value="hours">Timmar</option>
                    </select>
                </div>
            </div>
            
            <div class="mt-6 flex justify-end space-x-3">
                <button id="cancel-pdf-btn" class="px-4 py-2 text-blue-600 hover:text-gray-800">Avbryt</button>
                <button id="generate-pdf-btn" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition">Generera PDF</button>
                <button id="generate-word-btn" class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 transition">Generera Word</button>
            </div>
        </div>
    </div>

    <script>
        // Globala variabler
        let currentUser = null;
        let projects = [];
        let timeEntries = [];
        let currentFilter = {
            year: 'all',
            month: 'all',
            ob: 'all'
        };
        let companySettings = {};
        let sortAscending = false;
        
        // Funktion för att beräkna OB-timmar enligt specifika regler
        function calculateOBHours(start, end, breakHours) {
            const MS_PER_HOUR = 1000 * 60 * 60;
            const MINUTE_SEGMENT_MS = 60 * 1000;

            const startDate = new Date(start);
            const endDate = new Date(end);

            // Total arbetad tid (i timmar), exklusive rast
            const totalWorkedHours = ((endDate - startDate) / MS_PER_HOUR) - breakHours;

            // Initiera OB-timmarsräknare
            const obHours = {
                base: 0,
                ob1: 0,
                ob2: 0,
                ob3: 0,
                ob4: 0
            };

            // Bestäm OB-typ för en specifik timme
            function getHourType(date) {
                const hour = date.getHours() + date.getMinutes() / 60;
                const day = date.getDay(); // 0 = söndag

                if (day === 0) return 'ob4'; // Söndag: allt är OB 4
                if (day === 6) return hour >= 13 ? 'ob3' : 'base'; // Lördag
                if (hour >= 6 && hour < 18) return 'base';
                if (hour >= 18 && hour < 22) return 'ob1';
                return 'ob2'; // 22:00 till 06:00
            }

            // Simulera minut-för-minut
            let current = new Date(startDate.getTime());
            const totalSegmentTime = (endDate - startDate) / MS_PER_HOUR;
            const effectiveSegmentTime = totalSegmentTime - breakHours;
            const segmentsToSkip = Math.round(breakHours * 60); // i minuter

            let skippedSegments = 0;

            while (current < endDate) {
                const next = new Date(current.getTime() + MINUTE_SEGMENT_MS);
                if (skippedSegments < segmentsToSkip) {
                    skippedSegments++;
                } else {
                    const hourType = getHourType(current);
                    obHours[hourType] += 1 / 60;
                }
                current = next;
            }

            return {
                total: totalWorkedHours,
                breakdown: {
                    base: obHours.base,
                    ob1: obHours.ob1,
                    ob2: obHours.ob2,
                    ob3: obHours.ob3,
                    ob4: obHours.ob4
                }
            };
        }

        // Funktion för att formatera timmar
        function formatHours(hours) {
            return hours.toFixed(2);
        }
        
        // Funktion för att ladda användarprofil
        function loadUserProfile(userId) {
            const profileRef = window.firebase.ref(window.firebase.database, `users/${userId}/profile`);
            
            window.firebase.onValue(profileRef, (snapshot) => {
                const profileData = snapshot.val();
                if (profileData) {
                    document.getElementById('profile-firstname').value = profileData.firstname || '';
                    document.getElementById('profile-lastname').value = profileData.lastname || '';
                    document.getElementById('profile-email').value = profileData.email || '';
                    document.getElementById('profile-phone').value = profileData.phone || '';
                    document.getElementById('profile-personalnumber').value = profileData.personalnumber || '';
                    
                    // Uppdatera användarinformation i navbaren
                    document.getElementById('user-name').textContent = `${profileData.firstname || ''} ${profileData.lastname || ''}`.trim() || profileData.email;
                    document.getElementById('user-avatar').src = `https://ui-avatars.com/api/?name=${encodeURIComponent(profileData.firstname + ' ' + profileData.lastname || profileData.email)}&background=random`;
                }
            }, { onlyOnce: true });
        }
        
        // Funktion för att spara användarprofil
        function saveUserProfile(userId) {
            const profileData = {
                firstname: document.getElementById('profile-firstname').value,
                lastname: document.getElementById('profile-lastname').value,
                phone: document.getElementById('profile-phone').value,
                personalnumber: document.getElementById('profile-personalnumber').value
            };
            
            const profileRef = window.firebase.ref(window.firebase.database, `users/${userId}/profile`);
            window.firebase.update(profileRef, profileData)
                .then(() => {
                    alert('Profil sparad!');
                    document.getElementById('profile-modal').classList.add('hidden');
                })
                .catch((error) => {
                    console.error('Error saving profile:', error);
                    alert('Ett fel uppstod vid sparande av profil.');
                });
        }
        
        // Funktion för att ladda företagsinställningar
        function loadCompanySettings(userId) {
            const settingsRef = window.firebase.ref(window.firebase.database, `users/${userId}/companySettings`);
            
            window.firebase.onValue(settingsRef, (snapshot) => {
                const settingsData = snapshot.val();
                if (settingsData) {
                    companySettings = settingsData;
                    document.getElementById('company-name').value = settingsData.name || '';
                    document.getElementById('company-address').value = settingsData.address || '';
                    document.getElementById('company-postal').value = settingsData.postal || '';
                    document.getElementById('company-phone').value = settingsData.phone || '';
                    document.getElementById('company-orgnr').value = settingsData.orgnr || '';
                }
            }, { onlyOnce: true });
        }
        
        // Funktion för att spara företagsinställningar
        function saveCompanySettings(userId) {
            const settingsData = {
                name: document.getElementById('company-name').value,
                address: document.getElementById('company-address').value,
                postal: document.getElementById('company-postal').value,
                phone: document.getElementById('company-phone').value,
                orgnr: document.getElementById('company-orgnr').value
            };
            
            const settingsRef = window.firebase.ref(window.firebase.database, `users/${userId}/companySettings`);
            window.firebase.set(settingsRef, settingsData)
                .then(() => {
                    alert('Företagsinställningar sparade!');
                    companySettings = settingsData;
                })
                .catch((error) => {
                    console.error('Error saving company settings:', error);
                    alert('Ett fel uppstod vid sparande av företagsinställningar.');
                });
        }
        
        // Funktion för att ladda projekt
		function loadProjects(userId) {
			const projectsRef = window.firebase.ref(window.firebase.database, `users/${userId}/projects`);

			window.firebase.onValue(projectsRef, (snapshot) => {
				const projectsList = document.getElementById('projects-list');
				const projectSelect = document.getElementById('project-select');
				const editProjectSelect = document.getElementById('edit-project');
				const pdfProjectSelect = document.getElementById('pdf-project');

				projects = [];
				projectsList.innerHTML = "";

				// Limpiar selects
				while (projectSelect.options.length > 1) projectSelect.remove(1);
				while (editProjectSelect.options.length > 1) editProjectSelect.remove(1);
				while (pdfProjectSelect.options.length > 1) pdfProjectSelect.remove(1);

				snapshot.forEach((childSnapshot) => {
					const project = {
						id: childSnapshot.key,
						...childSnapshot.val()
					};
					projects.push(project);

					// Agregar opciones
					const opt = document.createElement('option');
					opt.value = project.id;
					opt.textContent = project.name;

					projectSelect.appendChild(opt.cloneNode(true));
					editProjectSelect.appendChild(opt.cloneNode(true));
					pdfProjectSelect.appendChild(opt.cloneNode(true));

					// Lista de proyectos (pantalla proyectos)
					const item = document.createElement('div');
					item.className = 'flex justify-between items-center bg-gray-50 p-3 rounded mb-2';
					item.innerHTML = `
						<div class="flex-1">
							<span class="font-medium">${project.name}</span>
							<p class="text-sm text-gray-500">${project.code}</p>
							${project.description ? `<p class="text-sm text-gray-500">${project.description}</p>` : ''}
						</div>
						<button class="delete-project text-red-500 hover:text-red-700 p-2" data-id="${project.id}">
							<i class="fas fa-trash"></i>
						</button>
					`;
					projectsList.appendChild(item);
				});

				// ⬅️ ***AUTO-SELECCIONAR PRIMER PROYECTO***
				if (projects.length > 0) {
					document.getElementById("project-select").value = projects[0].id;
				}

				// Listener para eliminar proyectos
				document.querySelectorAll('.delete-project').forEach(btn => {
					btn.addEventListener('click', (e) => {
						deleteProject(e.currentTarget.dataset.id);
					});
				});
			});
		}


					// Funktion för att ladda tidsregistreringar
					function loadTimeEntries(userId) {
						const timeRef = window.firebase.ref(window.firebase.database, `users/${userId}/timeEntries`);
						
						window.firebase.onValue(timeRef, (snapshot) => {
							timeEntries = [];
							const historyContainer = document.getElementById('hours-history');
							historyContainer.innerHTML = '';
							
							// Rensa sammanfattning
							document.getElementById('base-hours').textContent = '0.00';
							document.getElementById('ob1-hours').textContent = '0.00';
							document.getElementById('ob2-hours').textContent = '0.00';
							document.getElementById('ob3-hours').textContent = '0.00';
							document.getElementById('ob4-hours').textContent = '0.00';
							
							// Ackumulatorer för statistik
							let projectStats = {};
							let weekStats = {};
							let obSummary = {
								base: 0,
								ob1: 0,
								ob2: 0,
								ob3: 0,
								ob4: 0
							};
                
                // Gruppera poster per månad
                const entriesByMonth = {};
                
                snapshot.forEach((childSnapshot) => {
                    const entry = {
                        id: childSnapshot.key,
                        ...childSnapshot.val()
                    };
                    
                    timeEntries.push(entry);
                    
                    // Beräkna timmar
                    const breakHours = parseFloat(entry.breakTime) || 0;
                    const obHours = calculateOBHours(entry.startTime, entry.endTime, breakHours);
                    
                    // Använd det sparade datumfältet för filtrering (redan i lokal tid)
                    const entryDate = new Date(entry.date);
                    const entryYear = entryDate.getFullYear();
                    const entryMonth = entryDate.getMonth() + 1;
                    
                    if (currentFilter.year !== 'all' && entryYear !== parseInt(currentFilter.year)) {
                        return;
                    }
                    
                    if (currentFilter.month !== 'all' && entryMonth !== parseInt(currentFilter.month)) {
                        return;
                    }
                    
                    // Filtrera efter OB-typ om aktiv
                    if (currentFilter.ob !== 'all') {
                        let include = false;
                        switch(currentFilter.ob) {
                            case 'base': include = obHours.breakdown.base > 0; break;
                            case 'ob1': include = obHours.breakdown.ob1 > 0; break;
                            case 'ob2': include = obHours.breakdown.ob2 > 0; break;
                            case 'ob3': include = obHours.breakdown.ob3 > 0; break;
                            case 'ob4': include = obHours.breakdown.ob4 > 0; break;
                        }
                        if (!include) return;
                    }
                    
                    // Uppdatera OB-sammanfattning
                    obSummary.base += obHours.breakdown.base;
                    obSummary.ob1 += obHours.breakdown.ob1;
                    obSummary.ob2 += obHours.breakdown.ob2;
                    obSummary.ob3 += obHours.breakdown.ob3;
                    obSummary.ob4 += obHours.breakdown.ob4;
                    
                    // Uppdatera projektstatistik
                    const projectName = entry.projectName || 'Inget projekt';
                    if (!projectStats[projectName]) {
                        projectStats[projectName] = 0;
                    }
                    projectStats[projectName] += obHours.total;
                    
                    // Uppdatera veckostatistik
                    const weekStart = getWeekStartDate(new Date(entry.date));
                    const weekKey = `${weekStart.getFullYear()}-${String(weekStart.getMonth() + 1).padStart(2, '0')}-${String(weekStart.getDate()).padStart(2, '0')}`;
                    
                    if (!weekStats[weekKey]) {
                        weekStats[weekKey] = 0;
                    }
                    weekStats[weekKey] += obHours.total;
                    
                    // Gruppera efter månad med det sparade datumfältet
                    const monthKey = `${entryYear}-${String(entryMonth).padStart(2, '0')}`;
                    if (!entriesByMonth[monthKey]) {
                        entriesByMonth[monthKey] = [];
                    }
                    entriesByMonth[monthKey].push({...entry, obHours});
                });
                
                // Uppdatera OB-sammanfattning
                document.getElementById('base-hours').textContent = formatHours(obSummary.base);
                document.getElementById('ob1-hours').textContent = formatHours(obSummary.ob1);
                document.getElementById('ob2-hours').textContent = formatHours(obSummary.ob2);
                document.getElementById('ob3-hours').textContent = formatHours(obSummary.ob3);
                document.getElementById('ob4-hours').textContent = formatHours(obSummary.ob4);
                const total = obSummary.base + obSummary.ob1 + obSummary.ob2 + obSummary.ob3 + obSummary.ob4;
                document.getElementById('total-hours').textContent = formatHours(total);
                
				// Skapa månadsgrupper
				const monthKeys = Object.keys(entriesByMonth).sort();
				if (sortAscending) {
					monthKeys.reverse();
				}

				monthKeys.forEach(monthKey => {
					const entries = entriesByMonth[monthKey];
					const [year, month] = monthKey.split('-');
					const monthNames = ['Januari', 'Februari', 'Mars', 'April', 'Maj', 'Juni', 'Juli', 'Augusti', 'September', 'Oktober', 'November', 'December'];
					const monthName = monthNames[parseInt(month) - 1];
					
					const monthGroup = document.createElement('div');
					monthGroup.className = 'month-group';
					
					const monthHeader = document.createElement('div');
					monthHeader.className = 'month-header';
					monthHeader.dataset.month = monthKey;
					monthHeader.innerHTML = `
						<h3 class="font-medium">${monthName} ${year}</h3>
						<span class="chevron"><i class="fas fa-chevron-down"></i></span>
					`;
					
					const monthContent = document.createElement('div');
					monthContent.className = 'month-content collapsed'; // Inicialmente colapsado
					
					// Ordenar entradas por fecha
					entries.sort((a, b) => {
						const dateA = new Date(a.date);
						const dateB = new Date(b.date);
						return sortAscending ? dateA - dateB : dateB - dateA;
					});
					
					const table = document.createElement('table');
					table.className = 'min-w-full divide-y divide-gray-200';
					table.innerHTML = `
						<thead class="bg-gray-50">
							<tr>
								<th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
									<button class="sort-date-btn" data-month="${monthKey}">
										Datum <i class="fas fa-sort"></i>
									</button>
								</th>
								<th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Projekt</th>
								<th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Timmar</th>
								<th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Detaljer</th>
								<th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Åtgärder</th>
							</tr>
						</thead>
						<tbody class="bg-white divide-y divide-gray-200">
							${entries.map(entry => {
								const dateStr = new Date(entry.date).toLocaleDateString('sv-SE');
								const projectName = entry.projectName || 'Inget projekt';
								
								return `
									<tr>
										<td class="px-4 py-2 whitespace-nowrap">${dateStr}</td>
										<td class="px-4 py-2">${projectName}</td>
										<td class="px-4 py-2">${formatHours(entry.obHours.total)}</td>
										<td class="px-4 py-2">
											<button class="view-detail text-blue-600 hover:underline" data-id="${entry.id}">
												<i class="fas fa-eye mr-1"></i> Detaljer
											</button>
										</td>
										<td class="px-4 py-2 whitespace-nowrap">
											<button class="text-blue-500 hover:text-blue-700 mr-2 edit-entry p-1" data-id="${entry.id}">
												<i class="fas fa-edit"></i>
											</button>
											<button class="text-red-500 hover:text-red-700 delete-entry p-1" data-id="${entry.id}">
												<i class="fas fa-trash"></i>
											</button>
										</td>
									</tr>
								`;
							}).join('')}
						</tbody>
					`;
					
					monthContent.appendChild(table);
					monthGroup.appendChild(monthHeader);
					monthGroup.appendChild(monthContent);
					historyContainer.appendChild(monthGroup);
				});
                
                // Lägg till event listeners för månadsgrupper
                document.querySelectorAll('.month-header').forEach(header => {
                    header.addEventListener('click', () => {
                        const content = header.nextElementSibling;
                        const chevron = header.querySelector('.chevron i');
                        
                        if (content.classList.contains('collapsed')) {
                            content.classList.remove('collapsed');
                            content.classList.add('expanded');
                            chevron.classList.add('rotated');
                        } else {
                            content.classList.remove('expanded');
                            content.classList.add('collapsed');
                            chevron.classList.remove('rotated');
                        }
                    });
                });
                
                // Uppdatera diagram
                updateCharts(projectStats, weekStats);
                
                // Lägg till event listeners för att visa detaljer
                document.querySelectorAll('.view-detail').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const entryId = e.currentTarget.getAttribute('data-id');
                        showEntryDetail(entryId);
                    });
                });
                
                // Lägg till event listeners för redigering
                document.querySelectorAll('.edit-entry').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const entryId = e.currentTarget.getAttribute('data-id');
                        showEditForm(entryId);
                    });
                });
                
                // Lägg till event listeners för att ta bort registreringar
                document.querySelectorAll('.delete-entry').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const entryId = e.currentTarget.getAttribute('data-id');
                        deleteTimeEntry(entryId);
                    });
                });
            });
        }
        
        // Funktion för att få veckans startdatum (måndag)
        function getWeekStartDate(date) {
            // Skapa en kopia av datumet i lokal tid (utan timmar)
            const d = new Date(date.getFullYear(), date.getMonth(), date.getDate());
            const day = d.getDay(); // 0 = söndag
            const diff = d.getDate() - day + (day === 0 ? -6 : 1); // måndag som start
            return new Date(d.setDate(diff));
        }
        
        // Funktion för att uppdatera diagram
        function updateCharts(projectStats, weekStats) {
            // Projektfördelningsdiagram
            const projectCtx = document.getElementById('project-chart');
            if (!projectCtx) return;
            
            // Förstör föregående diagram om det finns
            if (window.projectChart) {
                window.projectChart.destroy();
            }
            
            window.projectChart = new Chart(projectCtx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(projectStats),
                    datasets: [{
                        data: Object.values(projectStats),
                        backgroundColor: [
                            '#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        },
                        title: {
                            display: true,
                            text: 'Fördelning per projekt'
                        }
                    }
                }
            });
            
            // Veckodiagram
            const weeklyCtx = document.getElementById('weekly-chart');
            if (!weeklyCtx) return;
            
            // Sortera veckor
            const sortedWeeks = Object.keys(weekStats).sort();
            const weekLabels = sortedWeeks.map(week => {
                const date = new Date(week);
                return `V ${date.getWeek()}`;
            });
            
            // Förstör föregående diagram om det finns
            if (window.weeklyChart) {
                window.weeklyChart.destroy();
            }
            
            window.weeklyChart = new Chart(weeklyCtx, {
                type: 'bar',
                data: {
                    labels: weekLabels,
                    datasets: [{
                        label: 'Timmar per vecka',
                        data: sortedWeeks.map(week => weekStats[week]),
                        backgroundColor: '#3b82f6'
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }
        
        // Funktion för att skapa nytt projekt
        function createProject() {
            const name = document.getElementById('project-name').value.trim();
            const code = document.getElementById('project-code').value.trim();
            const description = document.getElementById('project-description').value.trim();
            
            if (!name || !code) {
                alert('Ange både projektnamn och projektkod');
                return;
            }
            
            const newProject = {
                name,
                code,
                description,
                createdAt: new Date().toISOString()
            };
            
            const projectsRef = window.firebase.ref(window.firebase.database, `users/${currentUser.uid}/projects`);
            window.firebase.push(projectsRef, newProject);
            
            // Stäng modal och rensa fält
            document.getElementById('project-modal').classList.add('hidden');
            document.getElementById('project-name').value = '';
            document.getElementById('project-code').value = '';
            document.getElementById('project-description').value = '';
        }
        
        // Funktion för att ta bort projekt
        function deleteProject(projectId) {
            if (confirm('Är du säker på att du vill ta bort detta projekt? Det går inte att ångra.')) {
                const projectRef = window.firebase.ref(window.firebase.database, `users/${currentUser.uid}/projects/${projectId}`);
                window.firebase.remove(projectRef);
            }
        }
        
        // Funktion för att spara tidsregistrering
        function saveTimeEntry() {
            const date = document.getElementById('work-date').value;
            const projectId = document.getElementById('project-select').value;
            const startTime = document.getElementById('start-time').value;
            const endTime = document.getElementById('end-time').value;
            const breakTime = document.getElementById('break-time').value || '0.5';
            const colleagues = document.getElementById('colleagues').value;
            const notes = document.getElementById('notes').value;
            
            if (!date || !projectId || !startTime || !endTime) {
                alert('Fyll i alla obligatoriska fält');
                return;
            }
            
            // Hämta projektnamn
            const project = projects.find(p => p.id === projectId);
            const projectName = project ? project.name : '';
            
            // Skapa fullständiga datumobjekt med korrekt hantering av tidszoner
            const startDateTime = new Date(`${date}T${startTime}`);
            const endDateTime = new Date(`${date}T${endTime}`);
            
            // Om sluttid är före starttid, antag att det är nästa dag
            if (endDateTime < startDateTime) {
                endDateTime.setDate(endDateTime.getDate() + 1);
            }

            // 🚀 Fix här: gör datumet lokalt (medianoche) för att undvika UTC-skift
            const [y, m, d] = date.split("-");
            const localDate = new Date(y, m - 1, d); 

            const newEntry = {
                date,
                projectId,
                projectName,
                startTime: startDateTime.toISOString(),
                endTime: endDateTime.toISOString(),
                breakTime: parseFloat(breakTime),
                colleagues,
                notes,
                createdAt: new Date().toISOString()
            };
            
            const timeRef = window.firebase.ref(window.firebase.database, `users/${currentUser.uid}/timeEntries`);
            window.firebase.push(timeRef, newEntry);
            
            // Rensa formulär
            document.getElementById('start-time').value = '01:30';
            document.getElementById('end-time').value = '10:00';
            document.getElementById('break-time').value = '0.5';
            document.getElementById('colleagues').value = '';
            document.getElementById('notes').value = '';
            
            // Visa mensaje de éxito
            alert('Tidsregistrering sparad!');
        }

        // Funktion för att visa registreringsdetaljer
        function showEntryDetail(entryId) {
            const entry = timeEntries.find(e => e.id === entryId);
            if (!entry) return;
            
            // Beräkna timmar
            const breakHours = parseFloat(entry.breakTime) || 0;
            const obHours = calculateOBHours(entry.startTime, entry.endTime, breakHours);
            
            const detailContent = document.getElementById('detail-content');
            detailContent.innerHTML = `
                <div class="grid grid-cols-2 gap-2">
                    <div class="font-medium">Datum:</div>
                    <div>${new Date(entry.date).toLocaleDateString('sv-SE')}</div>
                    
                    <div class="font-medium">Projekt:</div>
                    <div>${entry.projectName || 'Inget projekt'}</div>
                    
                    <div class="font-medium">Tid:</div>
                    <div>${new Date(entry.startTime).toLocaleTimeString('sv-SE', {hour: '2-digit', minute:'2-digit'})} - ${new Date(entry.endTime).toLocaleTimeString('sv-SE', {hour: '2-digit', minute:'2-digit'})}</div>
                    
                    <div class="font-medium">Totalt antal timmar:</div>
                    <div>${formatHours(obHours.total)} h</div>
                    
                    <div class="font-medium">Rast:</div>
                    <div>${entry.breakTime} h</div>
                </div>
                
                <div class="pt-3">
                    <div class="font-medium">OB-uppdelning:</div>
                    <div class="grid grid-cols-2 gap-2 mt-2">
                        <div class="ob-base p-2 rounded text-center">
                            <div class="font-bold">Baslön</div>
                            <div>${formatHours(obHours.breakdown.base)} h</div>
                        </div>
                        <div class="ob-1 p-2 rounded text-center">
                            <div class="font-bold">OB 1</div>
                            <div>${formatHours(obHours.breakdown.ob1)} h</div>
                        </div>
                        <div class="ob-2 p-2 rounded text-center">
                            <div class="font-bold">OB 2</div>
                            <div>${formatHours(obHours.breakdown.ob2)} h</div>
                        </div>
                        <div class="ob-3 p-2 rounded text-center">
                            <div class="font-bold">OB 3</div>
                            <div>${formatHours(obHours.breakdown.ob3)} h</div>
                        </div>
                        <div class="ob-4 p-2 rounded text-center">
                            <div class="font-bold">OB 4</div>
                            <div>${formatHours(obHours.breakdown.ob4)} h</div>
                        </div>
                    </div>
                </div>
                
                ${entry.colleagues ? `
                <div class="pt-3">
                    <div class="font-medium">Kollegor:</div>
                    <div>${entry.colleagues}</div>
                </div>
                ` : ''}
                
                ${entry.notes ? `
                <div class="pt-3">
                    <div class="font-medium">Anteckningar:</div>
                    <div>${entry.notes}</div>
                </div>
                ` : ''}
            `;
            
            document.getElementById('detail-modal').classList.remove('hidden');
        }

        
        // Funktion för att visa redigeringsformulär
        function showEditForm(entryId) {
            const entry = timeEntries.find(e => e.id === entryId);
            if (!entry) return;
            
            // Fyll i formulär
            document.getElementById('edit-id').value = entry.id;
            document.getElementById('edit-date').value = entry.date;
            document.getElementById('edit-start').value = new Date(entry.startTime).toTimeString().substring(0,5);
            document.getElementById('edit-end').value = new Date(entry.endTime).toTimeString().substring(0,5);
            document.getElementById('edit-break').value = entry.breakTime;
            document.getElementById('edit-colleagues').value = entry.colleagues || '';
            document.getElementById('edit-notes').value = entry.notes || '';
            
            // Välj projekt
            const editProject = document.getElementById('edit-project');
            for (let i = 0; i < editProject.options.length; i++) {
                if (editProject.options[i].value === entry.projectId) {
                    editProject.selectedIndex = i;
                    break;
                }
            }
            
            document.getElementById('edit-modal').classList.remove('hidden');
        }
        
        // Funktion för att spara ändringar i registrering
        function saveEditedEntry() {
            const entryId = document.getElementById('edit-id').value;
            const date = document.getElementById('edit-date').value;
            const projectId = document.getElementById('edit-project').value;
            const startTime = document.getElementById('edit-start').value;
            const endTime = document.getElementById('edit-end').value;
            const breakTime = document.getElementById('edit-break').value;
            const colleagues = document.getElementById('edit-colleagues').value;
            const notes = document.getElementById('edit-notes').value;
            
            if (!date || !projectId || !startTime || !endTime) {
                alert('Fyll i alla obligatoriska fält');
                return;
            }
            
            // Hämta projektnamn
            const project = projects.find(p => p.id === projectId);
            const projectName = project ? project.name : '';
            
            // Skapa fullständiga datumobjekt
            const startDateTime = new Date(`${date}T${startTime}`);
            const endDateTime = new Date(`${date}T${endTime}`);
            
            // Om sluttid är före starttid, antag att det är nästa dag
            if (endDateTime < startDateTime) {
                endDateTime.setDate(endDateTime.getDate() + 1);
            }
            
            const updatedEntry = {
                date,
                projectId,
                projectName,
                startTime: startDateTime.toISOString(),
                endTime: endDateTime.toISOString(),
                breakTime: parseFloat(breakTime),
                colleagues,
                notes
            };
            
            const entryRef = window.firebase.ref(window.firebase.database, `users/${currentUser.uid}/timeEntries/${entryId}`);
            window.firebase.update(entryRef, updatedEntry);
            
            // Stäng modal
            document.getElementById('edit-modal').classList.add('hidden');
            
            // Visa mensaje de éxito
            alert('Tidsregistrering uppdaterad!');
        }
        
        // Funktion för att ta bort tidsregistrering
        function deleteTimeEntry(entryId) {
            if (confirm('Är du säker på att du vill ta bort denna registrering? Det går inte att ångra.')) {
                const entryRef = window.firebase.ref(window.firebase.database, `users/${currentUser.uid}/timeEntries/${entryId}`);
                window.firebase.remove(entryRef);
            }
        }
        
        function exportToPDF() {
            document.getElementById('pdf-filter-modal').classList.remove('hidden');
            
            const today = new Date();
            const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
            const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0);

            // formatear YYYY-MM-DD en local time
            const formatDate = (d) => {
                const year = d.getFullYear();
                const month = String(d.getMonth() + 1).padStart(2, '0');
                const day = String(d.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            };

            document.getElementById('pdf-start-date').value = formatDate(firstDay);
            document.getElementById('pdf-end-date').value = formatDate(lastDay);
        }

        // Funktion för att generera PDF baserat på filter
        function generatePDF() {
            try {
                // Hämta filtervärden
                const startDate = document.getElementById('pdf-start-date').value;
                const endDate = document.getElementById('pdf-end-date').value;
                const projectId = document.getElementById('pdf-project').value;
                const obType = document.getElementById('pdf-ob').value;
                const sortBy = document.getElementById('pdf-sort').value;
                
                // Filtrera registreringar baserat på det sparade datumfältet (ISO i localDate)
                let filteredEntries = timeEntries.filter(entry => {
                    const entryDateObj = new Date(entry.date);
                    const entryYMD = entryDateObj.toISOString().split("T")[0]; // YYYY-MM-DD

                    // Datumfilter
                    if (startDate && entryYMD < startDate) return false;
                    if (endDate && entryYMD > endDate) return false;
                    
                    // Projektfilter
                    if (projectId !== 'all' && entry.projectId !== projectId) return false;
                    
                    // OB-filter
                    if (obType !== 'all') {
                        const breakHours = parseFloat(entry.breakTime) || 0;
                        const obHours = calculateOBHours(entry.startTime, entry.endTime, breakHours);
                        
                        switch(obType) {
                            case 'base': if (obHours.breakdown.base <= 0) return false; break;
                            case 'ob1': if (obHours.breakdown.ob1 <= 0) return false; break;
                            case 'ob2': if (obHours.breakdown.ob2 <= 0) return false; break;
                            case 'ob3': if (obHours.breakdown.ob3 <= 0) return false; break;
                            case 'ob4': if (obHours.breakdown.ob4 <= 0) return false; break;
                        }
                    }
                    
                    return true;
                });
                
                // Sortera registreringar
                filteredEntries.sort((a, b) => {
                    const aDate = new Date(a.date);
                    const bDate = new Date(b.date);
                    
                    switch(sortBy) {
                        case 'date': return aDate - bDate;
                        case 'project': return a.projectName.localeCompare(b.projectName);
                        case 'hours': 
                            const aHours = calculateOBHours(a.startTime, a.endTime, parseFloat(a.breakTime) || 0).total;
                            const bHours = calculateOBHours(b.startTime, b.endTime, parseFloat(b.breakTime) || 0).total;
                            return bHours - aHours;
                        default: return aDate - bDate;
                    }
                });
                
                // Beräkna sammanfattning
                let summary = { base: 0, ob1: 0, ob2: 0, ob3: 0, ob4: 0, total: 0 };
                filteredEntries.forEach(entry => {
                    const breakHours = parseFloat(entry.breakTime) || 0;
                    const obHours = calculateOBHours(entry.startTime, entry.endTime, breakHours);
                    summary.base += obHours.breakdown.base;
                    summary.ob1 += obHours.breakdown.ob1;
                    summary.ob2 += obHours.breakdown.ob2;
                    summary.ob3 += obHours.breakdown.ob3;
                    summary.ob4 += obHours.breakdown.ob4;
                    summary.total += obHours.total;
                });
                
                // Skapa PDF
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // Sidhuvud
                doc.setFontSize(16);
                doc.setTextColor(40);
                doc.setFont("helvetica", "bold");
                doc.text('Tidrapport', 105, 15, { align: 'center' });
                
                doc.setFontSize(10);
                doc.setFont("helvetica", "normal");
                
                // Företagsinfo
                if (companySettings.address) doc.text(companySettings.address, 20, 25);
                if (companySettings.postal) doc.text(companySettings.postal, 20, 30);
                if (companySettings.phone) doc.text(`Tel ${companySettings.phone}`, 20, 35);
                if (companySettings.orgnr) doc.text(`Organisationsnummer: ${companySettings.orgnr}`, 20, 40);
                
                // Användarinformation
                const userName = document.getElementById('user-name').textContent;
                doc.text(`Användare: ${userName}`, 140, 25);
                doc.text(`Exporterad: ${new Date().toLocaleDateString('sv-SE')}`, 140, 30);
                
                // Sammanfattningstabell
                const summaryHeaders = [['Timtyp', 'Timmar']];
                const summaryData = [
                    ['Baslön', formatHours(summary.base)],
                    ['OB 1', formatHours(summary.ob1)],
                    ['OB 2', formatHours(summary.ob2)],
                    ['OB 3', formatHours(summary.ob3)],
                    ['OB 4', formatHours(summary.ob4)],
                    ['TOTALT', formatHours(summary.total)]
                ];
                
                doc.autoTable({
                    head: summaryHeaders,
                    body: summaryData,
                    startY: 50,
                    theme: 'grid',
                    headStyles: { fillColor: [59, 130, 246], textColor: 255, fontStyle: 'bold' },
                    styles: { fontSize: 12 },
                    columnStyles: { 0: { cellWidth: 60, fontStyle: 'bold' }, 1: { cellWidth: 40 } }
                });
                
                // Detaljerad tabell
                const detailHeaders = [['Datum', 'Projekt', 'Totalt', 'Baslön', 'OB 1', 'OB 2', 'OB 3', 'OB 4']];
                const detailData = filteredEntries.map(entry => {
                    const breakHours = parseFloat(entry.breakTime) || 0;
                    const obHours = calculateOBHours(entry.startTime, entry.endTime, breakHours);
                    const entryDateObj = new Date(entry.date);
                    return [
                        entryDateObj.toLocaleDateString('sv-SE'),
                        entry.projectName || 'Inget projekt',
                        formatHours(obHours.total),
                        formatHours(obHours.breakdown.base),
                        formatHours(obHours.breakdown.ob1),
                        formatHours(obHours.breakdown.ob2),
                        formatHours(obHours.breakdown.ob3),
                        formatHours(obHours.breakdown.ob4)
                    ];
                });
                
                const lastY = doc.lastAutoTable.finalY + 10;
                doc.autoTable({
                    head: detailHeaders,
                    body: detailData,
                    startY: lastY,
                    theme: 'grid',
                    headStyles: { fillColor: [40, 40, 40], textColor: 255, fontStyle: 'bold' },
                    styles: { fontSize: 10 },
                    columnStyles: {
                        0: { cellWidth: 25 }, 1: { cellWidth: 40 }, 2: { cellWidth: 20 },
                        3: { cellWidth: 20 }, 4: { cellWidth: 15 }, 5: { cellWidth: 15 },
                        6: { cellWidth: 15 }, 7: { cellWidth: 15 }
                    },
                    margin: { top: 10 }
                });
                
                // Sidfot
                const pageCount = doc.internal.getNumberOfPages();
                for (let i = 1; i <= pageCount; i++) {
                    doc.setPage(i);
                    doc.setFontSize(10);
                    doc.text(`Sida ${i} av ${pageCount}`, 195, 285, { align: 'right' });
                    doc.text('Tidbok OB - Timregistreringssystem', 15, 285);
                }
                
                // Spara
                doc.save(`${userName.replace(/\s+/g, '_')}_tidrapport.pdf`);
                
                // Stäng modal
                document.getElementById('pdf-filter-modal').classList.add('hidden');
                
            } catch (error) {
                console.error("Fel vid generering av PDF:", error);
                alert("Ett fel inträffade vid generering av PDF. Kontrollera konsolen för mer information.");
            }
        }

        
        // Funktion för att exportera till Word
        function exportToWord() {
            // Hämta filtervärden
            const startDate = document.getElementById('pdf-start-date').value;
            const endDate = document.getElementById('pdf-end-date').value;
            const projectId = document.getElementById('pdf-project').value;
            const obType = document.getElementById('pdf-ob').value;
            const sortBy = document.getElementById('pdf-sort').value;
            
            // Filtrera registreringar baserat på det sparade datumfältet (lokal tid)
            let filteredEntries = timeEntries.filter(entry => {
                // Använd det sparade datumfältet för korrekt filtrering
                const entryDate = entry.date;
                
                // Datumfilter
                if (startDate && entryDate < startDate) return false;
                if (endDate && entryDate > endDate) return false;
                
                // Projektfilter
                if (projectId !== 'all' && entry.projectId !== projectId) return false;
                
                // OB-filter
                if (obType !== 'all') {
                    const breakHours = parseFloat(entry.breakTime) || 0;
                    const obHours = calculateOBHours(entry.startTime, entry.endTime, breakHours);
                    
                    switch(obType) {
                        case 'base': if (obHours.breakdown.base <= 0) return false; break;
                        case 'ob1': if (obHours.breakdown.ob1 <= 0) return false; break;
                        case 'ob2': if (obHours.breakdown.ob2 <= 0) return false; break;
                        case 'ob3': if (obHours.breakdown.ob3 <= 0) return false; break;
                        case 'ob4': if (obHours.breakdown.ob4 <= 0) return false; break;
                    }
                }
                
                return true;
            });
            
            // Sortera registreringar
            filteredEntries.sort((a, b) => {
                const aDate = new Date(a.date);
                const bDate = new Date(b.date);
                
                switch(sortBy) {
                    case 'date': return aDate - bDate;
                    case 'project': return a.projectName.localeCompare(b.projectName);
                    case 'hours': 
                        const aHours = calculateOBHours(a.startTime, a.endTime, parseFloat(a.breakTime) || 0).total;
                        const bHours = calculateOBHours(b.startTime, b.endTime, parseFloat(b.breakTime) || 0).total;
                        return bHours - aHours;
                    default: return aDate - bDate;
                }
            });
            
            // Beräkna sammanfattning
            let summary = {
                base: 0,
                ob1: 0,
                ob2: 0,
                ob3: 0,
                ob4: 0,
                total: 0
            };
            
            filteredEntries.forEach(entry => {
                const breakHours = parseFloat(entry.breakTime) || 0;
                const obHours = calculateOBHours(entry.startTime, entry.endTime, breakHours);
                summary.base += obHours.breakdown.base;
                summary.ob1 += obHours.breakdown.ob1;
                summary.ob2 += obHours.breakdown.ob2;
                summary.ob3 += obHours.breakdown.ob3;
                summary.ob4 += obHours.breakdown.ob4;
                summary.total += obHours.total;
            });
            
            // Skapa Word-innehåll
            let wordContent = `
            <html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:w="urn:schemas-microsoft-com:office:word" xmlns="http://www.w3.org/TR/REC-html40">
            <head>
                <meta charset="utf-8">
                <title>Tidrapport</title>
                <style>
                    body { font-family: Arial, sans-serif; }
                    h1 { color: #2c5282; }
                    table { border-collapse: collapse; width: 100%; }
                    th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                    th { background-color: #3b82f6; color: white; }
                    .summary-table { margin-bottom: 20px; }
                    .detail-table { margin-top: 20px; }
                </style>
            </head>
            <body>
                <h1 style="text-align: center;">Tidrapport</h1>
                
                <div style="margin-bottom: 20px;">
                    <p><strong>Företag:</strong> ${companySettings.name || ''}</p>
                    <p><strong>Adress:</strong> ${companySettings.address || ''}, ${companySettings.postal || ''}</p>
                    <p><strong>Telefon:</strong> ${companySettings.phone || ''}</p>
                    <p><strong>Organisationsnummer:</strong> ${companySettings.orgnr || ''}</p>
                    <p><strong>Användare:</strong> ${document.getElementById('user-name').textContent}</p>
                    <p><strong>Exporterad:</strong> ${new Date().toLocaleDateString('sv-SE')}</p>
                </div>
                
                <h2>Sammanfattning</h2>
                <table class="summary-table">
                    <tr>
                        <th>Timtyp</th>
                        <th>Timmar</th>
                    </tr>
                    <tr>
                        <td>Baslön</td>
                        <td>${formatHours(summary.base)}</td>
                    </tr>
                    <tr>
                        <td>OB 1</td>
                        <td>${formatHours(summary.ob1)}</td>
                    </tr>
                    <tr>
                        <td>OB 2</td>
                        <td>${formatHours(summary.ob2)}</td>
                    </tr>
                    <tr>
                        <td>OB 3</td>
                        <td>${formatHours(summary.ob3)}</td>
                    </tr>
                    <tr>
                        <td>OB 4</td>
                        <td>${formatHours(summary.ob4)}</td>
                    </tr>
                    <tr>
                        <td><strong>TOTALT</strong></td>
                        <td><strong>${formatHours(summary.total)}</strong></td>
                    </tr>
                </table>
                
                <h2>Detaljerad lista</h2>
                <table class="detail-table">
                    <tr>
                        <th>Datum</th>
                        <th>Projekt</th>
                        <th>Totalt</th>
                        <th>Baslön</th>
                        <th>OB 1</th>
                        <th>OB 2</th>
                        <th>OB 3</th>
                        <th>OB 4</th>
                    </tr>
            `;
            
            filteredEntries.forEach(entry => {
                const breakHours = parseFloat(entry.breakTime) || 0;
                const obHours = calculateOBHours(entry.startTime, entry.endTime, breakHours);
                
                wordContent += `
                    <tr>
                        <td>${new Date(entry.date).toLocaleDateString('sv-SE')}</td>
                        <td>${entry.projectName || 'Inget projekt'}</td>
                        <td>${formatHours(obHours.total)}</td>
                        <td>${formatHours(obHours.breakdown.base)}</td>
                        <td>${formatHours(obHours.breakdown.ob1)}</td>
                        <td>${formatHours(obHours.breakdown.ob2)}</td>
                        <td>${formatHours(obHours.breakdown.ob3)}</td>
                        <td>${formatHours(obHours.breakdown.ob4)}</td>
                    </tr>
                `;
            });
            
            wordContent += `
                </table>
                <p style="margin-top: 30px; font-size: 12px; text-align: center;">
                    Genererad av Tidbok OB - Timregistreringssystem
                </p>
            </body>
            </html>
            `;
            
            // Skapa och ladda ner Word-dokument
            const blob = new Blob([wordContent], { type: 'application/msword' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `${document.getElementById('user-name').textContent.replace(/\s+/g, '_')}_tidrapport.doc`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            // Stäng modal
            document.getElementById('pdf-filter-modal').classList.add('hidden');
        }
        
        // Initiera appen när DOM är klar
        document.addEventListener('DOMContentLoaded', () => {
            // Sätt aktuellt datum i datumfältet
            const today = new Date();
            const formattedDate = today.toISOString().split('T')[0];
            document.getElementById('work-date').value = formattedDate;
            
            // Konfigurera år för filter
            const yearSelect = document.getElementById('filter-year');
            const currentYear = today.getFullYear();
            for (let year = currentYear; year >= currentYear - 5; year--) {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                yearSelect.appendChild(option);
            }
            
            // Konfigurera månader för filter
            const monthSelect = document.getElementById('filter-month');
            const months = [
                'Januari', 'Februari', 'Mars', 'April', 'Maj', 'Juni',
                'Juli', 'Augusti', 'September', 'Oktober', 'November', 'December'
            ];
            
            months.forEach((month, index) => {
                const option = document.createElement('option');
                option.value = index + 1;
                option.textContent = month;
                monthSelect.appendChild(option);
            });
            
            // Menú móvil
            const menuItems = document.querySelectorAll('.mobile-menu-item');
            const sections = document.querySelectorAll('.section');
            
            menuItems.forEach(item => {
                item.addEventListener('click', () => {
                    const sectionId = item.getAttribute('data-section');
                    
                    // Actualizar menú activo
                    menuItems.forEach(i => i.classList.remove('active'));
                    item.classList.add('active');
                    
                    // Mostrar sección correspondiente
                    sections.forEach(section => {
                        section.classList.remove('active');
                        if (section.id === `${sectionId}-section`) {
                            section.classList.add('active');
                        }
                    });
                });
            });
            
            // Mostrar menú móvil solo cuando el usuario esté autenticado
            const updateMobileMenu = (user) => {
                const mobileMenu = document.getElementById('mobile-menu');
                if (user) {
                    mobileMenu.classList.add('active');
                } else {
                    mobileMenu.classList.remove('active');
                }
            };
            
            // Initiera Firebase Auth state observer
            window.firebase.onAuthStateChanged(window.firebase.auth, (user) => {
                if (user) {
                    // Användare inloggad
                    currentUser = user;
                    document.getElementById('auth-screen').classList.add('hidden');
                    document.getElementById('app-content').classList.remove('hidden');
                    document.getElementById('user-info').classList.remove('hidden');
                    updateMobileMenu(user);
                    
                    // Ladda användardata
                    loadUserProfile(user.uid);
                    loadCompanySettings(user.uid);
                    loadProjects(user.uid);
                    loadTimeEntries(user.uid);
                } else {
                    // Användare inte inloggad
                    currentUser = null;
                    document.getElementById('auth-screen').classList.remove('hidden');
                    document.getElementById('app-content').classList.add('hidden');
                    document.getElementById('user-info').classList.add('hidden');
                    updateMobileMenu(null);
                }
            });
            
            // Event listeners för autentisering
            document.getElementById('login-tab-btn').addEventListener('click', () => {
                document.getElementById('login-tab-btn').classList.add('active');
                document.getElementById('register-tab-btn').classList.remove('active');
                document.getElementById('login-tab').classList.add('active');
                document.getElementById('register-tab').classList.remove('active');
            });
            
            document.getElementById('register-tab-btn').addEventListener('click', () => {
                document.getElementById('register-tab-btn').classList.add('active');
                document.getElementById('login-tab-btn').classList.remove('active');
                document.getElementById('register-tab').classList.add('active');
                document.getElementById('login-tab').classList.remove('active');
            });
            
            document.getElementById('login-btn').addEventListener('click', () => {
                const email = document.getElementById('email').value;
                const password = document.getElementById('password').value;
                const authMessage = document.getElementById('auth-message');
                
                if (!email || !password) {
                    authMessage.textContent = 'Fyll i både e-post och lösenord';
                    return;
                }
                
                window.firebase.signInWithEmailAndPassword(window.firebase.auth, email, password)
                    .catch((error) => {
                        authMessage.textContent = error.message;
                    });
            });
            
            document.getElementById('register-btn').addEventListener('click', () => {
                const email = document.getElementById('reg-email').value;
                const password = document.getElementById('reg-password').value;
                const firstname = document.getElementById('reg-firstname').value;
                const lastname = document.getElementById('reg-lastname').value;
                const phone = document.getElementById('reg-phone').value;
                const personalnumber = document.getElementById('reg-personalnumber').value;
                const authMessage = document.getElementById('auth-message');
                
                if (!email || !password || !firstname || !lastname) {
                    authMessage.textContent = 'Fyll i alla obligatoriska fält';
                    return;
                }
                
                window.firebase.createUserWithEmailAndPassword(window.firebase.auth, email, password)
                    .then((userCredential) => {
                        // Spara användarprofil
                        const user = userCredential.user;
                        const profileData = {
                            firstname,
                            lastname,
                            email,
                            phone,
                            personalnumber
                        };
                        
                        const profileRef = window.firebase.ref(window.firebase.database, `users/${user.uid}/profile`);
                        return window.firebase.set(profileRef, profileData);
                    })
                    .catch((error) => {
                        authMessage.textContent = error.message;
                    });
            });

            document.getElementById('logout-btn').addEventListener('click', () => {
                window.firebase.signOut(window.firebase.auth);
            });

            // ============================
            // EVENT LISTENERS – PROFIL
            // ============================

            // Spara profil
            document.getElementById('save-profile-btn').addEventListener('click', () => {
                if (currentUser) {
                    saveUserProfile(currentUser.uid);
                } else {
                    alert("Ingen användare är inloggad.");
                }
            });

            // Avbryt profil
            document.getElementById('cancel-profile-btn').addEventListener('click', () => {
                document.getElementById('profile-modal').classList.add('hidden');
            });

            // Öppna profil-modal från navbar-knappen
            document.getElementById('profile-btn').addEventListener('click', () => {
                if (currentUser) {
                    loadUserProfile(currentUser.uid);
                    document.getElementById('profile-modal').classList.remove('hidden');
                } else {
                    alert("Du måste logga in först.");
                }
            });

            
            document.getElementById('settings-toggle').addEventListener('click', () => {
                const settingsPanel = document.getElementById('settings-panel');
                settingsPanel.classList.toggle('hidden');
            });
            
            document.getElementById('company-settings-form').addEventListener('submit', (e) => {
                e.preventDefault();
                if (currentUser) {
                    saveCompanySettings(currentUser.uid);
                }
            });
            
            document.getElementById('new-project-btn').addEventListener('click', () => {
                document.getElementById('project-modal').classList.remove('hidden');
            });
            
            document.getElementById('create-project-btn').addEventListener('click', () => {
                document.getElementById('project-modal').classList.remove('hidden');
            });
            
            document.getElementById('cancel-project-btn').addEventListener('click', () => {
                document.getElementById('project-modal').classList.add('hidden');
            });
            
            document.getElementById('save-project-btn').addEventListener('click', createProject);
            
            document.getElementById('save-hours-btn').addEventListener('click', saveTimeEntry);
            
            document.getElementById('close-detail-btn').addEventListener('click', () => {
                document.getElementById('detail-modal').classList.add('hidden');
            });
            
            document.getElementById('export-pdf').addEventListener('click', exportToPDF);
            
            document.getElementById('export-word').addEventListener('click', exportToPDF);
            
            document.getElementById('generate-pdf-btn').addEventListener('click', generatePDF);
            
            document.getElementById('generate-word-btn').addEventListener('click', exportToWord);
            
            document.getElementById('cancel-pdf-btn').addEventListener('click', () => {
                document.getElementById('pdf-filter-modal').classList.add('hidden');
            });
            
            // Filter
            document.getElementById('filter-year').addEventListener('change', (e) => {
                currentFilter.year = e.target.value;
                if (currentUser) loadTimeEntries(currentUser.uid);
            });
            
            document.getElementById('filter-month').addEventListener('change', (e) => {
                currentFilter.month = e.target.value;
                if (currentUser) loadTimeEntries(currentUser.uid);
            });
            
            document.getElementById('filter-ob').addEventListener('change', (e) => {
                currentFilter.ob = e.target.value;
                if (currentUser) loadTimeEntries(currentUser.uid);
            });
            
            // Sortering
            document.getElementById('sort-order').addEventListener('click', () => {
                sortAscending = !sortAscending;
                const icon = document.getElementById('sort-order').querySelector('i');
                if (sortAscending) {
                    icon.classList.remove('fa-sort-amount-down');
                    icon.classList.add('fa-sort-amount-up');
                } else {
                    icon.classList.remove('fa-sort-amount-up');
                    icon.classList.add('fa-sort-amount-down');
                }
                if (currentUser) loadTimeEntries(currentUser.uid);
            });
            
            // Redigering
            document.getElementById('cancel-edit-btn').addEventListener('click', () => {
                document.getElementById('edit-modal').classList.add('hidden');
            });
            
            document.getElementById('save-edit-btn').addEventListener('click', saveEditedEntry);
            
            // Upptäck anslutningsstatus
            window.addEventListener('online', () => {
                const status = document.getElementById('connection-status');
                status.classList.remove('connection-offline');
                status.classList.add('connection-online');
                status.innerHTML = '<span class="w-3 h-3 rounded-full bg-white mr-1"></span> Online';
            });
            
            window.addEventListener('offline', () => {
                const status = document.getElementById('connection-status');
                status.classList.remove('connection-online');
                status.classList.add('connection-offline');
                status.innerHTML = '<span class="w-3 h-3 rounded-full bg-white mr-1"></span> Offline';
            });
            
            // Tillägg för att få veckonummer
            Date.prototype.getWeek = function() {
                const date = new Date(this.getTime());
                date.setHours(0, 0, 0, 0);
                date.setDate(date.getDate() + 3 - (date.getDay() + 6) % 7);
                const week1 = new Date(date.getFullYear(), 0, 4);
                return 1 + Math.round(((date.getTime() - week1.getTime()) / 86400000 - 3 + (week1.getDay() + 6) % 7) / 7);
            };
        });
    </script>
</body>
</html>


